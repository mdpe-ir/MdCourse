---
title: "ุณุงุฎุช Load Balancer ุฏุฑ ฺฏูููฺฏ"
description: "ุณุงุฎุช ฺฉ Load Balancer ุฏุฑ ฺฏูููฺฏ ..."
image: "images/post/_83251b90-1b15-40d6-b1ae-cb03b0e12056.jpeg"
date: 2023-12-29T21:09:55+03:30
draft: false
author: "Mahan"
tags: [ "golang", "go" , "network" , 'webserver' ]
categories: [ "golang" ]
---

**Load Balancer ูุง ุฏุฑ ูุนูุงุฑ ูุจ ููุด ุงุณุงุณ ุฏุงุฑู.**

ฺููฺฉู ุงุฌุงุฒู ูุฏู ุจุงุฑ ุจู ูุฌููุนู ุง ุงุฒ backendูุง ุชูุฒุน ุจุดู. ุงู ุจุงุนุซ ููุงุณ ูพุฐุฑ ุจุดุชุฑ ุฎุฏูุงุช ูุดู ู ุฏุฑ ููุงุช ุณุฑูุณ ุจุง
ุฏุงุดุชู load balancer ุชุดุฎุต ุจุฏู ฺฉุฏูู ุณุฑูุฑ ุชุฑุงูฺฉ ุฒุงุฏ ุฑูุดู ุง ุฎุฑุงุจ ุดุฏู ู ุชุฑุงูฺฉ ุฑุง ุจู ุณุฑูุฑ ูุง ุขูุงุฏู ุจู ฺฉุงุฑ ููุชูู ฺฉูู.

ุชู ุงู ูพุณุช ูุฑุงุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ Golang ฺฉ ููุฏ ุจุงูุงูุณุฑ ุงุฌุงุฏ ฺฉูู.

### ููุฏ ุจุงูุงูุณุฑ ูุง ฺุทูุฑ ฺฉุงุฑ ูฺฉููุ

ุงุณุชุฑุงุชฺ ูุง ูุฎุชูู ุจุฑุง ุณุงุฎุช ููุฏุจุงูุงูุณุฑ ูุฌูุฏ ุฏุงุฑู ฺฉู ฺุทูุฑ ุชุฑุงูฺฉ ุฑุง ุฏุฑ ุจู ุจฺฉูุฏ ูุง ุชูุณู ฺฉููุฏ.

ุจู ุทูุฑ ฺฉู ุฏู ุฏุณุชู ุงุฒ ุงู ุงูฺฏูุฑุชูโูุง ูุฌูุฏ ุฏุงุฑุฏ:

โ ุงุณุชุงุชฺฉ (Static):

- Round Robin
- Sticky Round Robin
- Hash
- Weighted Round Robin

โ ูพูุง (Dynamic):

- Least Connections
- Least Response Time

ุจุงุฏ ุจู ูุฑ ุงูฺฏูุฑุชู ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ ูฺฏุงู ฺฉูู:

๐ Round Robin:
ุฏุฑุฎูุงุณุชโูุง ุจู ุตูุฑุช ูุชูุงู ุฏุฑ ุจู ฺฏุฑูู ุงุฒ ุณุฑูุฑูุง ุชูุฒุน ูโุดููุฏ. ูฺ ุชุถูู ูุฌูุฏ ูุฏุงุฑุฏ ฺฉู ฺูุฏู ุฏุฑุฎูุงุณุช ุงุฒ ฺฉ ฺฉุงุฑุจุฑ ุจู ฺฉ
ููููู (instance) ุจุฑุณูุฏ.

๐ Sticky Round Robin:
ฺฉ ุฌุงฺฏุฒู ุจูุชุฑ ุจุฑุง Round Robin. ุฏุฑุฎูุงุณุชโูุง ูุฎุชูู ุงุฒ ฺฉ ฺฉุงุฑุจุฑ ุจู ฺฉ ููููู (instance) ูุงุญุฏ ูโุฑุณูุฏ.

๐ Hash-Based:
ุงู ุงูฺฏูุฑุชู ุฏุฑุฎูุงุณุชโูุง ุฑุง ุจุฑ ุงุณุงุณ ูุด ููุฏุงุฑ ฺฉูุฏ ุชูุฒุน ูโฺฉูุฏ. ฺฉูุฏ ูโุชูุงูุฏ ุขุฏุฑุณ IP ุง URL ุฏุฑุฎูุงุณุช ุจุงุดุฏ.

๐ Weighted Round Robin:
ูุฑ ุณุฑูุฑ ฺฉ ููุฏุงุฑ ูุฒู ุฏุฑุงูุช ูโฺฉูุฏ. ุงู ููุฏุงุฑุ ูุณุจุช ุชุฑุงูฺฉ ุฑุง ุชุนู ูโฺฉูุฏ. ุณุฑูุฑูุง ุจุง ูุฒู ุจุงูุงุชุฑุ ุชุฑุงูฺฉ ุจุดุชุฑ ุฏุฑุงูุช
ูโฺฉููุฏ. ุงู ุงูฺฏูุฑุชู ุจุฑุง ุชูุธูุงุช ฺฉู ุณุฑูุฑูุง ุจุง ุณุทูุญ ุธุฑูุช ูุฎุชูู ุฏุงุฑูุฏุ ููุงุณุจ ุงุณุช.

๐ Least Connections:
ุฏุฑุฎูุงุณุช ุฌุฏุฏ ุจู ููููู ุณุฑูุฑ ุจุง ฺฉูุชุฑู ุชุนุฏุงุฏ ุงุชุตุงูุงุช ุงุฑุณุงู ูโุดูุฏ. ุชุนุฏุงุฏ ุงุชุตุงูุงุช ุจุฑ ุงุณุงุณ ุธุฑูุช ูุญุงุณุจุงุช ูุณุจ ฺฉ ุณุฑูุฑ ุชุนู
ูโุดูุฏ.

๐ Least Response Time:
ุฏุฑุฎูุงุณุช ุฌุฏุฏ ุจู ุณุฑูุฑ ุจุง ฺฉูุชุฑู ุฒูุงู ูพุงุณุฎ ุงุฑุณุงู ูโุดูุฏ ุชุง ุฒูุงู ูพุงุณุฎ ฺฉู ุจู ุญุฏุงูู ุจุฑุณุฏ. ุงู ุงูฺฏูุฑุชู ุจุฑุง ููุงุฑุฏ ฺฉู ุฒูุงู
ูพุงุณุฎ ุญุงุช ุงุณุชุ ููุงุณุจ ุงุณุช.

[ููุจุน: ูพุณุช ฺฉุงูุงู](https://t.me/MdDaily/273)

ุฎุจ ูู ุงูุฌุง ุงุฒ ุงูฺฏูุฑุชู ู ุงุณุชุฑุงุชฺ *Round Robin* ุงุณุชูุงุฏู ู ฺฉูู

![image](/images/post/lb/lb-archi.0b1c2c4.b3e35c7510dc44451088756d14739161.png)


### Round Robin

Round Robin ุฏุฑ ุงุตุทูุงุญ ุณุงุฏุณ . ุจู worker ูุง ูุฑุตุช ุจุฑุงุจุฑ ูุฏู ุชุง ุจู ููุจุช ูุธุงู ุฎูุฏุดูู ุฑู ุงูุฌุงู ุจุฏู.



![image](/images/post/lb/lb-rr.a901b4a.3b34a78610b7c1e2d22b85f0419700d2.png)

ููุงูุทูุฑ ฺฉู ุฏุฑ ุดฺฉู ูุดูู ุฏุงุฏู ุดุฏูุ ุงู ุจู ุทูุฑ ูุฏุงูู ุงุชูุงู ูููุชู. ุงูุง ูู ุชููู ุงู ุฑู ูุณุชููุงู ุงุณุชูุงุฏู ฺฉููุ ููุ

ุงฺฏุฑ ฺฉ ุณุฑูุฑ ุจฺฉูุฏ **ุฏุงูู**/**down** ุจุดูุ ุงุญุชูุงูุงู ููุฎูุงู ุชุฑุงูฺฉ ุฑู ุจูุด ูุฏุงุช ฺฉูู. ุจูุงุจุฑุงูุ ุงู ููุชููู ูุณุชููุงู ุงุณุชูุงุฏู ุจุดู ูฺฏุฑ ุงูฺฉู ุจุฑุฎ ุดุฑุงุท ุฑูุด ุงุนูุงู ุจุดู. ุจุงุฏ ุชุฑุงูฺฉ ุฑู ููุท ุจู ุณุฑูุฑูุง ฺฉู ุฑูุดู ู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชูุ ูุฏุงุช ฺฉูู.

### ุจุงุฏ ฺูุฏ ุณุงุฎุชุงุฑ ุฑุง ุชุนุฑู ฺฉูู

ูพุณ ุงุฒ ุจุงุฒูฺฏุฑ ุฏุฑ ุทุฑุญุ ุงฺฉููู ูุฏููู ฺฉู ูุงุฒ ุจู ุฑุงู ุจุฑุง track ุชูุงู ุฌุฒุฆุงุช ูุฑุจูุท ุจู Backend ุฏุงุฑู. ุจุงุฏ ูพฺฏุฑ ฺฉูู ฺฉู ุขุง ุฏุฑ ุฏุณุชุฑุณู ุง ุฎุงููุด ู ููฺูู URL ุฑู ูู track ฺฉูู.

ูุชููู ุฎู ุณุงุฏู ู struct ูุซูู ุงู ุฑู ุชุนุฑู ฺฉูู ุชุง ุจฺฉูุฏ ูุงููู ุฑู ูฺฏู ุฏุงุฑู:
```go
type Backend struct {
  URL          *url.URL
  Alive        bool
  mux          sync.RWMutex
  ReverseProxy *httputil.ReverseProxy
}
```

ูฺฏุฑุงู ูุจุงุดุฏย**ุฌูู ุชุฑ ุจู ููุฏ ูุง Backend ู ูพุฑุฏุงุฒู**.

ุญุงูุง ูุงุฒ ุฏุงุฑู ุฑุงู ุจุฑุง track ุชูุงู ุจฺฉูุฏ ูุง ุฏุฑ ูุชุนุงุฏู ููุฏ ุจุงูุงูุณุฑ ุฎูุฏููู ูพุฏุง ฺฉููุ ุจุฑุง ุงู ฺฉุงุฑ ูุชููู ุจู ุณุงุฏฺฏ ุงุฒ ู Slice ุงุณุชูุงุฏู ฺฉูู. ู ููฺูู ฺฉ ูุชุบุฑ ุดูุงุฑูุฏู. ูุง ูุชููู ุงูู ูุง ุฑู ุฏุฑ ServerPool ุชุนุฑู ฺฉูู

```go
type ServerPool struct {
  backends []*Backend
  current  uint64
}
```

### ุงุณุชูุงุฏู ุงุฒ ReverseProxy

ููุงูุทูุฑ ฺฉู ูุจูุงู ุชุนุฑู ฺฉุฑุฏู ุ ูุฏู ุงุตู  ููุฏ ุจุงูุงูุณุฑ ูุฏุงุช ุชุฑุงูฺฉ ุจู ุณุฑูุฑูุง ูุฎุชูู ู ุจุงุฒฺฏุดุช ูุชุงุฌ ุจู ฺฉูุงูุช ุงุตูู.

**ุทุจู ูุณุชูุฏุงุช Go:**
> ReverseProxy ฺฉ Handler HTTP ุงุณุช ฺฉู ุฏุฑุฎูุงุณุช ูุฑูุฏ ุฑุง ู ฺฏุฑุฏ ู ุขู ุฑุง ุจู ุณุฑูุฑ ุฏฺฏุฑ ุงุฑุณุงู ู ฺฉูุฏ ู ูพุงุณุฎ ุฑุง ุจู ฺฉูุงูุช ูพุฑูฺฉุณ ู ฺฉูุฏ.

ุงู ุฏููุงู ูููู ฺุฒู ฺฉู ูุฎูุงู. ูุงุฒ ุจู ุงุฎุชุฑุงุน ุฏูุจุงุฑู ฺุฑุฎ ูุณุช. ูุชููู ุฏุฑุฎูุงุณุช ูุง ุงุตูููู ุฑู ุงุฒ ุทุฑู ReverseProxy ููุชูู ฺฉูู.

```go
u, _ := url.Parse("http://localhost:8080")
rp := httputil.NewSingleHostReverseProxy(u)
  
// initialize your server and add this as handler
http.HandlerFunc(rp.ServeHTTP)
```

ุจุง ุงุณุชูุงุฏู ุงุฒ** httputil.NewSingleHostReverseProxy(url)** ูุชููู ู ReverseProxy ุฑู ุฑุงู ุงูุฏุงุฒ ฺฉูู ฺฉู ุฏุฑุฎูุงุณุชโูุง ุฑุง ุจู URL ุงุฑุณุงู ุดุฏู ุงุฑุณุงู ฺฉูู. ุฏุฑ ูุซุงู ุจุงูุงุ ููู ุฏุฑุฎูุงุณุชโูุง ุจู localhost:8080 ููุชูู ูุดู ู ูุชุงุฌ ุจู ฺฉูุงูุช ุงุตู ุงุฑุณุงู ูุดู. 

ุงฺฏุฑ ูฺฏุงู ุจู ูุชุฏ **ServeHTTP** ุจูุฏุงุฒูุ signature ุงุด ูุดุงุจู signature ฺฉ **Handler HTTP** ุงุณุชุ ุจู ููู ุฏูู ูุชููู ุงูู ุฑู ุจู **HandlerFunc** ุฏุฑ **http** ูพุงุณ ุจุฏู.

ูุชููุฏ ูุซุงู ูุง ุจุดุชุฑ ุฑู ุชูย[docs](https://golang.org/pkg/net/http/httputil/#ReverseProxy) ุจุจูุฏ.

ุจุฑุง ููุฏ ุจุงูุงูุณุฑ ุณุงุฏููู ูุชููู ReverseProxy ุฑู ุจุง URL ูุฑุชุจุท ุฏุฑ Backend ุฑุงูโุงูุฏุงุฒ ฺฉูู ุชุง ReverseProxy ุฏุฑุฎูุงุณุชโูุง ูุง ุฑุง ุจู URL ูุฏุงุช ฺฉูุฏ.

### ูุฑุงูุฏ ุงูุชุฎุงุจ

ูุง ุจุงุฏ ุณุฑูุฑูุง ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุบุฑูุนุงู ูุณุชู ุฑู ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุจุนุฏ ุฏุฑุฎูุงุณุช ูุง ุฑุฏ ฺฉูู. ุงูุง ุจุฑุง ุงูุฌุงู ุงู ฺฉุงุฑ ุจู ุฑุงู ุจุฑุง ุดูุงุฑุด ูุงุฒ ุฏุงุฑู.

ฺูุฏู ฺฉูุงูุช ุจู ููุฏ ุจุงูุงูุณุฑ ูุชุตู ูุดู ู ููุช ฺฉู ูุฑ ฺฉ ุงุฒ ุงู ฺฉูุงูุช ูุง ุงุฒ peer ุจุนุฏ ุฏุฑุฎูุงุณุช ูฺฉูู ุชุง ุชุฑุงูฺฉ ุฑู ููุชูู ฺฉูู ุ ููฺฉู ุงุณุช ุดุฑุงุท race ุง ูุณุงุจูู ูุงููุฏ ุฑุฎ ุจุฏู. ุจุฑุง ุฌููฺฏุฑ ุงุฒุดุ ูุชููู Pool ุณุฑูุฑ ุฑู ุจุง ฺฉ ุฑูุฒูฺฏุงุฑ ููู ฺฉูู. ุงูุง ุงู ฺฉุงุฑ ุจุด ุงุฒ ุญุฏ ุถุฑูุฑ ุงุณุชุ ุนูุงูู ุจุฑ ุงู ูุง ููุฎูุงู Pool ุณุฑูุฑ ุฑู ุจู ุทูุฑ ฺฉู ููู ฺฉูู. ูุง ููุท ูุฎูุงู ุดูุงุฑูุฏู ุฑุง ุจู ฺฉ ูุงุญุฏ ุงูุฒุงุด ุจุฏู.

ุจุฑุง ุจุฑุขูุฑุฏู ฺฉุฑุฏู ุงู ุงูุฒุงูุงุชุ ุฑุงู ุญู ุงุฏู ุขู ุงูู ฺฉู ุงู ุงูุฒุงุด ุฑุง ุจู ุตูุฑุช ุงุชูฺฉ ุงูุฌุงู ุจุฏู. ู Go ุงู ฺฉุงุฑ ุฑู ุจู ุฎูุจ ุงุฒ ุทุฑู ูพฺฉุฌ atomic ูพุดุชุจุงู ู ฺฉูู.

```go
func (s *ServerPool) NextIndex() int {
  return int(atomic.AddUint64(&s.current, uint64(1)) % uint64(len(s.backends)))
}
```


ุฏุฑ ุงูุฌุงุ ูุง ุจู ุตูุฑุช ุงุชู ููุฏุงุฑ ูุนู ุฑู ฺฉ ุจุงุฑ ุงูุฒุงุด ูุฏู ู ุดุงุฎุต ุฑุง ุจุง ุทูู slice ุชุบุฑ ูุฏู. ูพุณ ุฏุฑ ูุชุฌู ููุฏุงุฑ ููุดู ุจู 0 ู ุทูู slice ูุณุชุด. ุฏุฑ ููุงุชุ ูุง ุจู index ุฎุงุต ุนูุงูู ููุฏูุ ูู ุชุนุฏุงุฏ ฺฉู.

### ุงูุชุฎุงุจ ฺฉ ุจฺฉูุฏ ูุนุงู/ุฒูุฏู

ูุฏููู ฺฉู ุฏุฑุฎูุงุณุช ูุง ูุง ุจู ุทูุฑ ฺุฑุฎุด ุจุฑุง ูุฑ backend ุงุฑุณุงู ูุดู. ุชููุง ฺฉุงุฑ ฺฉู ุจุงุฏ ุจฺฉูู ุงู ฺฉู ฺฉู ููุงุฑุฏ ุบุฑ ูุนุงู/ูุฑุฏู ุฑู ุญุฐู ฺฉูู.

GetNext() ููุดู ฺฉ ููุฏุงุฑ ุฑู ุจุฑูฺฏุฑุฏููู ฺฉู ุจู 0 ู ุทูู slice ูุญุฏูุฏ ุดุฏู. ุฏุฑ ูุฑ ููุทูุ ูุง ฺฉ peer ุจุนุฏ ุฏุฑุงูุช ู ฺฉูู ู ุงฺฏู ูุนุงู/ุฒูุฏู ูุจุงุดู ุจุงุฏ ุฏุฑ slice ุจู ุตูุฑุช ฺุฑุฎุด ุฌุณุชุฌู ฺฉูู.

![image](/images/post/lb/lb-slice-traverse.93ea44d.9c17a7fc56f9bf6c9e4583c29127aa55.png)

ููุงูุทูุฑ ฺฉู ุฏุฑ ุชุตูุฑ ุจุงูุง ูุดูู ุฏุงุฏู ุดุฏูุ ูุง ูุฎูุงู ุงุฒ next ุชุง entire list ูพูุงุด ฺฉููุ ฺฉู ูุชููู ุจู ุณุงุฏฺฏ ุจุง ูพูุงุด **next + length **ุงูุฌุงู ุจุดู. ุงูุง ุจุฑุง ุงูุชุฎุงุจ ฺฉ indexุ ูุฎูุงู ุงูู ูุง ุฑู ุจู ุทูู slice ูุญุฏูุฏ ฺฉูู. ุงู ฺฉุงุฑ ุจู ุฑุงุญุช ุจุง ุนูู mod ุงูุฌุงู ูุดู.

ุจุนุฏ ุงุฒ ูพุฏุง ุดุฏู ฺฉ backend ฺฉุงุฑุขูุฏ ุฏุฑ ุทูู ุฌุณุชุฌูุ ุงูู ุฑู ุจู ุนููุงู backend ูุนู ูุดุฎุต ู ฺฉูู.

ุฏุฑ ุฒุฑ ู ุชูุงูุฏ ฺฉุฏ ุจุฑุง ุนููุงุช ููู ุฑู ุจุจูุฏ:
```go
// GetNextPeer returns next active peer to take a connection
func (s *ServerPool) GetNextPeer() *Backend {
  // loop entire backends to find out an Alive backend
  next := s.NextIndex()
  l := len(s.backends) + next // start from next and move a full cycle
  for i := next; i < l; i++ {
    idx := i % len(s.backends) // take an index by modding with length
    // if we have an alive backend, use it and store if its not the original one
    if s.backends[idx].IsAlive() {
      if i != next {
        atomic.StoreUint64(&s.current, uint64(idx)) // mark the current one
      }
      return s.backends[idx]
    }
  }
  return nil
}
```


### ุงุฒ ุดุฑุงุท race/ูุณุงุจูู ุฏุฑ ุณุงุฎุชุงุฑ Backend ุงุฌุชูุงุจ ฺฉูุฏ

ฺฉ ูุณุฆูู ุฌุฏ ูุฌูุฏ ุฏุงุฑู ฺฉู ุจุงุฏ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุจุดู. ุณุงุฎุชุงุฑยBackendยูุง ุฏุงุฑุง ฺฉ ูุชุบุฑู ฺฉู ูุชููู ุชูุณุท goroutine ูุง ูุฎุชูู ููุฒูุงู ุชุบุฑ ุฏุงุฏู ุจุดู ุง ุจูุดูู ุฏุณุชุฑุณ ูพุฏุง ฺฉูู.

ูุง ูุฏููู ฺฉู ุจุดุชุฑ goroutine ูุง ุฑู ูุชุบุฑ ุจุดุชุฑ ุงุฒ ููุดุชู ุนููุงุช ุฎูุงูุฏู ุงูุฌุงู ูุฏู. ุจูุงุจุฑุงูุ ูุงยRWMutexยุฑู ุจุฑุง ุณุฑุงู ุณุงุฒ ุฏุณุชุฑุณ ุจูยAliveยุงูุชุฎุงุจ ู ฺฉูู.

```go
// SetAlive for this backend
func (b *Backend) SetAlive(alive bool) {
  b.mux.Lock()
  b.Alive = alive
  b.mux.Unlock()
}

// IsAlive returns true when backend is alive
func (b *Backend) IsAlive() (alive bool) {
  b.mux.RLock()
  alive = b.Alive
  b.mux.RUnlock()
  return
}
```


### ุจุงุฏ requests ูุง ุฑุง ููุฏ ุจุงูุงูุณ ฺฉูู

ุจุง ุชูุงู ุฒููู ูุง ฺฉู ุขูุงุฏู ฺฉุฑุฏู ุ ูุชููู ุฑูุด ุณุงุฏู ุฒุฑ ุฑู ุจุฑุง ููุฏ ุจุงูุงูุณ ุฏุฑุฎูุงุณุช ุงุณุชูุงุฏู ฺฉูู. ููุท ุฒูุงู ุดฺฉุณุช ูุฎูุฑู ฺฉู ุชูุงู backend ูุง ูุง ุขููุงู ุจุงุดู.

```go
// lb load balances the incoming request
func lb(w http.ResponseWriter, r *http.Request) {
  peer := serverPool.GetNextPeer()
  if peer != nil {
    peer.ReverseProxy.ServeHTTP(w, r)
    return
  }
  http.Error(w, "Service not available", http.StatusServiceUnavailable)
}
```

ุงู ุฑูุด ุฑู ูุดู ุจู ุณุงุฏฺฏ ุจู ุนููุงู ฺฉยHandlerFuncยุจู ุณุฑูุฑ http ููุชูู ฺฉุฑุฏ.

```go
server := http.Server{
  Addr:    fmt.Sprintf(":%d", port),
  Handler: http.HandlerFunc(lb),
}
```


### ุชุฑุงูฺฉ ุฑุง ููุท ุจู ุจฺฉูุฏ ูุง ุณุงูู ููุชูู ฺฉูุฏ

ูุดฺฉู ุฌุฏ ุฏุฑ ููุฏ ุจุงูุงูุณุฑ ูุนู ูุง ูุฌูุฏ ุฏุงุฑู. ููุฏููู ฺฉู ฺฉ ุณุฑูุฑ ุจฺฉูุฏ ุณุงููู ุง ูู. ุจุฑุง ูููุฏู ุงู ููุถูุน ุจุงุฏ ฺฉ ุณุฑูุฑ ุจฺฉูุฏ ุฑู ุงูุชุญุงู ฺฉูู ู ุจุจูู ุขุง ูุนุงูู . 

ุงู ฺฉุงุฑ ุฑู ูุชููู ุจู ุฏู ุฑูุด ุงูุฌุงู ุจุฏู:

- ูุนุงู: ุฏุฑ ุญู ุงูุฌุงู ุฏุฑุฎูุงุณุช ูุนูุ ุงฺฏุฑ ุณุฑูุฑ ุจฺฉูุฏ ุงูุชุฎุงุจ ุดุฏู ูพุงุณุฎฺฏู ูุจุงุดุฏุ ุงูู ุฑู ุจู ุนููุงู ุบุฑูุนุงู ุนูุงูุช ุจุฒูู.
- ุบุฑ ูุนุงู: ูุชููู ุณุฑูุฑูุง ุจฺฉูุฏ ุฑู ุฏุฑ ุจุงุฒูโูุง ุฒูุงู ุซุงุจุช ูพูฺฏ ฺฉูู ู ูุถุนุชุดูู ุฑู ุจุฑุฑุณ ฺฉูู.

### ุจู ุทูุฑ ูุนุงู ุจฺฉูุฏ ูุง ุณุงูู ุจุฑุฑุณ ู ุดูุฏ

**ReverseProxy** ุฏุฑ ุตูุฑุช ูููุน ูุฑฺฏููู ุฎุทุงุ ฺฉ ุชุงุจุน ุจุงุฒฺฏุดุช ุจู ูุงู **ErrorHandler** ุฑู ูุนุงู ูฺฉูู. ูุง ูุชููู ุงุฒุด ุจุฑุง ุชุดุฎุต ูุฑฺฏููู ุดฺฉุณุช ุงุณุชูุงุฏู ฺฉูู. ุฏุฑ ุงูุฌุง ูพุงุฏูโุณุงุฒุด ุงููุฏู:

```go
proxy.ErrorHandler = func(writer http.ResponseWriter, request *http.Request, e error) {
  log.Printf("[%s] %s\n", serverUrl.Host, e.Error())
  retries := GetRetryFromContext(request)
  if retries < 3 {
    select {
      case <-time.After(10 * time.Millisecond):
        ctx := context.WithValue(request.Context(), Retry, retries+1)
        proxy.ServeHTTP(writer, request.WithContext(ctx))
      }
      return
    }

  // after 3 retries, mark this backend as down
  serverPool.MarkBackendStatus(serverUrl, false)

  // if the same request routing for few attempts with different backends, increase the count
  attempts := GetAttemptsFromContext(request)
  log.Printf("%s(%s) Attempting retry %d\n", request.RemoteAddr, request.URL.Path, attempts)
  ctx := context.WithValue(request.Context(), Attempts, attempts+1)
  lb(writer, request.WithContext(ctx))
}
```

ุฏุฑ ุงูุฌุง ุงุฒ ูุฏุฑุช ุชูุงุจุน ุจุณุชูโุง ุจุฑุง ุทุฑุงุญ ุงู ErrorHandler ุงุณุชูุงุฏู ุดุฏู. ุงู ุงูฺฉุงู ุฑู ุจู ูุง ูุฏู ุชุง ูุชุบุฑูุง ุฎุงุฑุฌ ูุซู URL ุณุฑูุฑ ุฑู ุฏุฑ ุฑูุด ุฎูุฏ ุจฺฏุฑู. ุงู ุชุงุจุน ุจุฑุฑุณ ูฺฉูู ฺฉู ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุช ูุฌุฏุฏ ููุฌูุฏ ฺฉูุชุฑ ุงุฒ 3 ุจุงุดุฏุ ุงฺฏุฑ ุงูุฌูุฑ ุจุงุดูุ ููุงู ุฏุฑุฎูุงุณุช ุฑู ุฏูุจุงุฑู ุจู ููุงู ุณุฑูุฑ ุจฺฉูุฏ ุงุฑุณุงู ูโฺฉูู. ุฏูู ุงู ฺฉุงุฑ ุงูฺฉู ฺฉู ููฺฉูู ุณุฑูุฑ ุจู ุฏูู ุฎุทุงูุง ูููุช ุฏุฑุฎูุงุณุชโูุง ุดูุง ุฑุง ุฑุฏ ฺฉูู ู ููฺฉูู ูพุณ ุงุฒ ูุฏุช ฺฉูุชุงู ุฏุฑ ุฏุณุชุฑุณ ุจุงุดู (ููฺฉูู ุณุฑูุฑ ุงุฒ ุณูฺฉุชโูุง ุจุฑุง ูพุฐุฑุด ฺฉูุงูุช ูุง ุจุดุชุฑ ุฎุงู ุดุฏู ุจุงุดู). ุจูุงุจุฑุงูุ ูุง ฺฉ ุชุงูุฑ ูุฑุงุฑ ุฏุงุฏู ุชุง ุชุงุฎุฑ ุฏุฑ ุฏุฑุฎูุงุณุช ูุฌุฏุฏ ุฑุง ุจุฑุง ุญุฏูุฏ 10 ููโุซุงูู ุจู ุชุฃุฎุฑ ุจูุฏุงุฒู. ูุง ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุช ูุฌุฏุฏ ุฑู ุจุง ูุฑ ุฏุฑุฎูุงุณุช ุงูุฒุงุด ูุฏู.

ูพุณ ุงุฒ ูุฑ ุจุงุฑ ุชูุงุด ูุงููููุ ุงู backend ุฑู ุจู ุนููุงู ุบุฑูุนุงู/down ฺฏุฒุงุฑุด ูุฏู.

ูุฏู ุจุนุฏ ุงูฺฉู ฺฉู ฺฉ backend ุฌุฏุฏ ุฑู ุจุฑุง ูููู ุฏุฑุฎูุงุณุช ุงูุชุญุงู ฺฉูู. ุงู ฺฉุงุฑ ุฑุง ุจุง ูฺฏู ุฏุงุดุชู ุดูุงุฑูุฏู ุชูุงุด ุจุง ุงุณุชูุงุฏู ุงุฒ ุจุณุชู context ุงูุฌุงู ูุฏู. ูพุณ ุงุฒ ุงูุฒุงุด ุชุนุฏุงุฏ ุชูุงุดโูุงุ ุงูู ุฑู ุฏูุจุงุฑู ุจู ููุฏ ุจุงูุงูุณุฑ ุงุฑุณุงู ูโฺฉูู ุชุง ฺฉ peer ุฌุฏุฏ ุจุฑุง ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุช ุงูุชุฎุงุจ ฺฉูู.

ุญุงูุง ูุง ููุชููู ุงู ฺฉุงุฑ ุฑู ุจู ุทูุฑ ูุงูุญุฏูุฏ ุงูุฌุงู ุจุฏูุ ูพุณ ุจุงุฏ ุจุฑุฑุณ ฺฉูู ฺฉู ุขุง ุญุฏุงฺฉุซุฑ ุชูุงุด ูุจู ุงุฒ ูพุฑุฏุงุฒุด ุจุดุชุฑ ุฏุฑุฎูุงุณุช ุงูุฌุงู ุดุฏู ุง ูู.

ูุง ูุชููู ุจู ุณุงุฏฺฏ ุชุนุฏุงุฏ ุชูุงุดโูุง ููุฌูุฏ ุฏุฑ ุฏุฑุฎูุงุณุช ุฑู ุฏุฑุงูุช ฺฉูู ู ุงฺฏุฑ ุงุฒ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ุชุฌุงูุฒ ฺฉุฑุฏู ุจุงุดูุ ุฏุฑุฎูุงุณุช ุฑู ุญุฐู ฺฉูู.

```go
// lb load balances the incoming request
func lb(w http.ResponseWriter, r *http.Request) {
  attempts := GetAttemptsFromContext(r)
  if attempts > 3 {
    log.Printf("%s(%s) Max attempts reached, terminating\n", r.RemoteAddr, r.URL.Path)
    http.Error(w, "Service not available", http.StatusServiceUnavailable)
    return
  }

  peer := serverPool.GetNextPeer()
  if peer != nil {
    peer.ReverseProxy.ServeHTTP(w, r)
    return
  }
  http.Error(w, "Service not available", http.StatusServiceUnavailable)
}
```

*ุงู ูพุงุฏูโุณุงุฒ ุจุงุฒฺฏุดุชู.*

### ุงุณุชูุงุฏู ุงุฒ context

ูพฺฉุฌ context ุจู ุดูุง ุงูฺฉุงู ุฐุฎุฑู ุฏุงุฏู ูุง ููุฏ ุฏุฑ ฺฉ ุฏุฑุฎูุงุณุช Http ุฑู ูุฏู. ูุง ุงู ุฑู ุจู ุทูุฑ ฺฏุณุชุฑุฏู ุจุฑุง track ุฏุงุฏู ูุง ุฎุงุต ุฏุฑุฎูุงุณุช ูุงููุฏ ุชุนุฏุงุฏ ุชูุงุด ู ุชุนุฏุงุฏ ุชฺฉุฑุงุฑ ุงุณุชูุงุฏู ฺฉุฑุฏู.

ุงุจุชุฏุง ุจุงุฏ ฺฉูุฏูุง ุฑู ุจุฑุง context ูุดุฎุต ฺฉูู. ุชูุตู ูุดู ุงุฒ ฺฉูุฏูุง non-colliding integer ุจู ุฌุง ุฑุดุชู ูุง ุงุณุชูุงุฏู ุจุดู. Go ฺฉููู ฺฉูุฏ **iota** ุฑู ุจุฑุง ูพุงุฏู ุณุงุฒ ููุงุฏุฑ ุซุงุจุช ุจู ุตูุฑุช ุงูุฒุงุด ุงุฑุงุฆู ูุฏูุ ูุฑ ฺฉุฏุงู ุญุงู ฺฉ ููุฏุงุฑ ููุญุตุฑ ุจู ูุฑุฏู. ุงู ฺฉ ุฑุงู ุญู ุนุงู ุจุฑุง ุชุนุฑู ฺฉูุฏูุง ุนุฏุฏู.

```go
const (
  Attempts int = iota
  Retry
)
```

ุณูพุณ ูุชููู ููุฏุงุฑ ุฑู ููุงูุทูุฑ ฺฉู ูุนูููุงู ุจุง **HashMap** ุงูุฌุงู ูุฏูุ ุจุงุฒุงุจ ฺฉูู. ููุฏุงุฑ ุจุงุฒฺฏุดุช ูพุด ูุฑุถ ููฺฉูู ุจู ฺฉุงุฑุจุฑุฏ ุจุณุชฺฏ ุฏุงุดุชู ุจุงุดู.

```go
// GetAttemptsFromContext returns the attempts for request
func GetRetryFromContext(r *http.Request) int {
  if retry, ok := r.Context().Value(Retry).(int); ok {
    return retry
  }
  return 0
}
```

### ุจุฑุฑุณ ูุง ุณูุงูุช ุบุฑูุนุงู/Passive

ฺฺฉโูุง ุณูุงูุช Passive ุจู ูุง ุงูฺฉุงู ุจุงุฒุงุจ ุง ุดูุงุณุง ุจฺฉโุงูุฏูุง ุบุฑูุนุงู/ุฏุงูู/ุขููุงู ุฑู ูุฏู. ูุง ุจูโุทูุฑ ุฏูุฑูโุง ุจุง ููุงุตู ุฒูุงู ุซุงุจุช ุจฺฉโุงูุฏูุง ุฑู ุจุฑุง ุจุฑุฑุณ ูุถุนุชุดูู ูพูฺฏ ูโฺฉูู.

ุจุฑุง ูพูฺฏุ ุณุน ูโฺฉูู ฺฉ ุงุชุตุงู TCP ุจุฑูุฑุงุฑ ฺฉูู. ุงฺฏุฑ ุจฺฉโุงูุฏ ูพุงุณุฎ ุจุฏูุ ุงูู ุฑู ุฒูุฏู/ุขููุงู ุนูุงูุชโฺฏุฐุงุฑ ูโฺฉูู. ุงู ุฑูุด ุฑู ูุชููุฏ ุจุฑุง ุชูุงุณ ุจุง ฺฉ endpoint ุฎุงุต ูุงููุฏ /status ุชุบุฑ ุจุฏุฏ. ูุทูุฆู ุจุดุฏ ฺฉู ูพุณ ุงุฒ ุจุฑูุฑุงุฑ ุงุชุตุงูุ ุงูู ุฑุง ุจุจูุฏุฏ ุชุง ุจุงุฑ ุงุถุงู ุฏุฑ ุณุฑูุฑ ฺฉุงูุด ูพุฏุง ฺฉูู. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุณุน ูฺฉูู ุงุชุตุงู ุฑู ุญูุธ ฺฉูู ู ุฏุฑ ููุงุช ููุงุจุนุด ุชููู ูุดู.

```go
// isAlive checks whether a backend is Alive by establishing a TCP connection
func isBackendAlive(u *url.URL) bool {
  timeout := 2 * time.Second
  conn, err := net.DialTimeout("tcp", u.Host, timeout)
  if err != nil {
    log.Println("Site unreachable, error: ", err)
    return false
  }
  _ = conn.Close() // close it, we dont need to maintain this connection
  return true
}
```

ุญุงูุง ูุชููู ุณุฑูุฑูุง ุฑู ูุฑูุฑ ฺฉูู ู ูุถุนุชุดูู ุฑู ูุซู ฺฉุฏ ุฒุฑ ูุดุฎุต ฺฉูู:

```go
// HealthCheck pings the backends and update the status
func (s *ServerPool) HealthCheck() {
  for _, b := range s.backends {
    status := "up"
    alive := isBackendAlive(b.URL)
    b.SetAlive(alive)
    if !alive {
      status = "down"
    }
    log.Printf("%s [%s]\n", b.URL, status)
  }
}
```

ุจุฑุง ุงุฌุฑุง ุงู ฺฉุงุฑ ุจู ุทูุฑ ุฏูุฑู ุง ูุชููู ฺฉ ุชุงูุฑ ุฏุฑ Go ุดุฑูุน ฺฉูู. ููุช ฺฉู ฺฉ ุชุงูุฑ ุงุฌุงุฏ ุดุฏ ุ ุจู ุดูุง ุงูฺฉุงู ูุฏู ุงุฒ ุทุฑู ฺฉ ฺฉุงูุงู ุจุฑุง ุฑูุฏุงุฏ ฺฏูุด ฺฉูุฏ.

```go
// healthCheck runs a routine for check status of the backends every 20 secs
func healthCheck() {
  t := time.NewTicker(time.Second * 20)
  for {
    select {
    case <-t.C:
      log.Println("Starting health check...")
      serverPool.HealthCheck()
      log.Println("Health check completed")
    }
  }
}
```

ุฏุฑ ูุทุนู ฺฉุฏ ุจุงูุง ุ ฺฉุงูุงู <-t.C ูุฑ 20 ุซุงูู ฺฉ ููุฏุงุฑ ุฑู ุจุฑูฺฏุฑุฏููู. select ุงุฌุงุฒู ูุฏู ุชุง ุงู ุฑูุฏุงุฏ ุฑู ุชุดุฎุต ุจุฏู. select ุชุง ุฒูุงู ฺฉู ูฺ ููุฑุฏ ูพุด ูุฑุถ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดู ุ ููุชุธุฑ ุงุฌุฑุง ุญุฏุงูู ฺฉ case ูุณุช.

ุฏุฑ ููุงุชุ ุงู ฺฉุงุฑ ุฑู ุฏุฑ ฺฉ goroutine ุฌุฏุงฺฏุงูู ุงุฌุฑุง ฺฉูุฏ.

```go
go healthCheck()
```

### ุฌูุน ุจูุฏ

ูุชู ูุงุฑุณ:

ุฏุฑ ุงู ููุงูู ฺุฒูุง ุฒุงุฏ ุฑู ูพูุดุด ุฏุงุฏู. 
- ุงูุชุฎุงุจ Round Robin
- ReverseProxy ุงุฒ ฺฉุชุงุจุฎุงูู ุงุณุชุงูุฏุงุฑุฏ
- ูููโูุง ูุชูุงุจู (Mutexes)
- ุนููุงุช ุงุชู (Atomic Operations)
- ุชุงุจุนโูุง ุจุณุชู (Closures)
- ุฏุฑุฎูุงุณุชโูุง ุจุงุฒฺฏุดุช (Callbacks)
- ุนููุงุช ุงูุชุฎุงุจ (Select Operation)
ูููุฒ ฺฉุงุฑูุง ุฒุงุฏ ูุฌูุฏ ุฏุงุฑู ฺฉู ูุชููู ุจุฑุง ุจูุจูุฏ ููุฏ ุจุงูุงูุณุฑููู ุงูุฌุงู ุจุฏู.

ุจุฑุง ูุซุงู:
- ุงุฒ ฺฉ heap ุจุฑุง ูุฑุชุจ ฺฉุฑุฏู ุจฺฉูุฏ ูุง ุขููุงู ุงุณุชูุงุฏู ุจุดู ุชุง ุณุทุญ ุฌุณุชุฌู ุฑุง ฺฉุงูุด ุจุฏู
- statistics ูุง ุฑุง ุฌูุน ุขูุฑ ฺฉูุฏ
- ูพุดุชุจุงู ุงุฒ ูุงู ูพฺฉุฑุจูุฏ ุฑู ุงุถุงูู ฺฉูุฏ
- ู...


---
ุดูุง ูุชููุฏ ฺฉุฏ ููุฏ ุจุงูุงูุณุฑ ุฑุง ุฏุฑ ย[ุงู ุฑูพู](https://github.com/mdpe-ir/simplelb) ูุดุงูุฏู ฺฉูุฏ.

ููููู ฺฉู ุชุง ูพุงุงู ููุงูู ุฑู ุฎููุฏุฏ ๐
